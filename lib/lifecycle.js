'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _defaultProps = require('./defaultProps');

var _defaultProps2 = _interopRequireDefault(_defaultProps);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = {
  getDefaultProps: function getDefaultProps() {
    return _defaultProps2.default;
  },
  getInitialState: function getInitialState() {
    return {
      page: 0,
      pageSize: this.props.defaultPageSize || 10,
      sorting: this.props.defaultSorting,
      expandedRows: {},
      filtering: this.props.defaultFiltering
    };
  },
  getResolvedState: function getResolvedState(props, state) {
    var resolvedState = _extends({}, _utils2.default.compactObject(this.state), _utils2.default.compactObject(this.props), _utils2.default.compactObject(state), _utils2.default.compactObject(props));
    return resolvedState;
  },
  componentWillMount: function componentWillMount() {
    this.setStateWithData(this.getDataModel(this.getResolvedState()));
  },
  componentDidMount: function componentDidMount() {
    this.fireOnChange();
  },
  componentWillReceiveProps: function componentWillReceiveProps(nextProps, nextState) {
    var oldState = this.getResolvedState();
    var newState = this.getResolvedState(nextProps, nextState);

    if (oldState.defaultSorting !== newState.defaultSorting) {
      newState.sorting = newState.defaultSorting;
    }

    if (oldState.showFilters !== newState.showFilters || oldState.showFilters !== newState.showFilters) {
      newState.filtering = newState.defaultFiltering;
    }

    // Props that trigger a data update
    if (oldState.data !== newState.data || oldState.columns !== newState.columns || oldState.pivotBy !== newState.pivotBy || oldState.sorting !== newState.sorting || oldState.showFilters !== newState.showFilters || oldState.filtering !== newState.filtering) {
      this.setStateWithData(this.getDataModel(newState));
    }
  },
  setStateWithData: function setStateWithData(newState, cb) {
    var oldState = this.getResolvedState();
    var newResolvedState = this.getResolvedState({}, newState);
    var freezeWhenExpanded = newResolvedState.freezeWhenExpanded;

    // Default to unfrozen state

    newResolvedState.frozen = false;

    // If freezeWhenExpanded is set, check for frozen conditions
    if (freezeWhenExpanded) {
      // if any rows are expanded, freeze the existing data and sorting
      var keys = Object.keys(newResolvedState.expandedRows);
      for (var i = 0; i < keys.length; i++) {
        if (newResolvedState.expandedRows[keys[i]]) {
          newResolvedState.frozen = true;
          break;
        }
      }
    }

    // If the data isn't frozen and either the data or
    // sorting model has changed, update the data
    if (oldState.frozen && !newResolvedState.frozen || oldState.sorting !== newResolvedState.sorting || oldState.filtering !== newResolvedState.filtering || oldState.showFilters !== newResolvedState.showFilters || !newResolvedState.frozen && oldState.resolvedData !== newResolvedState.resolvedData) {
      // Handle collapseOnSortingChange & collapseOnDataChange
      if (oldState.sorting !== newResolvedState.sorting && this.props.collapseOnSortingChange || oldState.filtering !== newResolvedState.filtering || oldState.showFilters !== newResolvedState.showFilters || !newResolvedState.frozen && oldState.resolvedData !== newResolvedState.resolvedData && this.props.collapseOnDataChange) {
        newResolvedState.expandedRows = {};
      }

      Object.assign(newResolvedState, this.getSortedData(newResolvedState));
    }

    // Calculate pageSize all the time
    if (newResolvedState.sortedData) {
      newResolvedState.pages = newResolvedState.manual ? newResolvedState.pages : Math.ceil(newResolvedState.sortedData.length / newResolvedState.pageSize);
      newResolvedState.page = Math.max(newResolvedState.page >= newResolvedState.pages ? newResolvedState.pages - 1 : newResolvedState.page, 0);
    }

    return this.setState(newResolvedState, cb);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9saWZlY3ljbGUuanMiXSwibmFtZXMiOlsiZ2V0RGVmYXVsdFByb3BzIiwiZ2V0SW5pdGlhbFN0YXRlIiwicGFnZSIsInBhZ2VTaXplIiwicHJvcHMiLCJkZWZhdWx0UGFnZVNpemUiLCJzb3J0aW5nIiwiZGVmYXVsdFNvcnRpbmciLCJleHBhbmRlZFJvd3MiLCJmaWx0ZXJpbmciLCJkZWZhdWx0RmlsdGVyaW5nIiwiZ2V0UmVzb2x2ZWRTdGF0ZSIsInN0YXRlIiwicmVzb2x2ZWRTdGF0ZSIsImNvbXBhY3RPYmplY3QiLCJjb21wb25lbnRXaWxsTW91bnQiLCJzZXRTdGF0ZVdpdGhEYXRhIiwiZ2V0RGF0YU1vZGVsIiwiY29tcG9uZW50RGlkTW91bnQiLCJmaXJlT25DaGFuZ2UiLCJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwibmV4dFByb3BzIiwibmV4dFN0YXRlIiwib2xkU3RhdGUiLCJuZXdTdGF0ZSIsInNob3dGaWx0ZXJzIiwiZGF0YSIsImNvbHVtbnMiLCJwaXZvdEJ5IiwiY2IiLCJuZXdSZXNvbHZlZFN0YXRlIiwiZnJlZXplV2hlbkV4cGFuZGVkIiwiZnJvemVuIiwia2V5cyIsIk9iamVjdCIsImkiLCJsZW5ndGgiLCJyZXNvbHZlZERhdGEiLCJjb2xsYXBzZU9uU29ydGluZ0NoYW5nZSIsImNvbGxhcHNlT25EYXRhQ2hhbmdlIiwiYXNzaWduIiwiZ2V0U29ydGVkRGF0YSIsInNvcnRlZERhdGEiLCJwYWdlcyIsIm1hbnVhbCIsIk1hdGgiLCJjZWlsIiwibWF4Iiwic2V0U3RhdGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7Ozs7O2tCQUVlO0FBQ2JBLGlCQURhLDZCQUNNO0FBQ2pCO0FBQ0QsR0FIWTtBQUtiQyxpQkFMYSw2QkFLTTtBQUNqQixXQUFPO0FBQ0xDLFlBQU0sQ0FERDtBQUVMQyxnQkFBVSxLQUFLQyxLQUFMLENBQVdDLGVBQVgsSUFBOEIsRUFGbkM7QUFHTEMsZUFBUyxLQUFLRixLQUFMLENB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ZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJy4vdXRpbHMnXG5pbXBvcnQgZGVmYXVsdFByb3BzIGZyb20gJy4vZGVmYXVsdFByb3BzJ1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGdldERlZmF1bHRQcm9wcyAoKSB7XG4gICAgcmV0dXJuIGRlZmF1bHRQcm9wc1xuICB9LFxuXG4gIGdldEluaXRpYWxTdGF0ZSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhZ2U6IDAsXG4gICAgICBwYWdlU2l6ZTogdGhpcy5wcm9wcy5kZWZhdWx0UGFnZVNpemUgfHwgMTAsXG4gICAgICBzb3J0aW5nOiB0aGlzLnByb3BzLmRlZmF1bHRTb3J0aW5nLFxuICAgICAgZXhwYW5kZWRSb3dzOiB7fSxcbiAgICAgIGZpbHRlcmluZzogdGhpcy5wcm9wcy5kZWZhdWx0RmlsdGVyaW5nXG4gICAgfVxuICB9LFxuXG4gIGdldFJlc29sdmVkU3RhdGUgKHByb3BzLCBzdGF0ZSkge1xuICAgIGNvbnN0IHJlc29sdmVkU3RhdGUgPSB7XG4gICAgICAuLi5fLmNvbXBhY3RPYmplY3QodGhpcy5zdGF0ZSksXG4gICAgICAuLi5fLmNvbXBhY3RPYmplY3QodGhpcy5wcm9wcyksXG4gICAgICAuLi5fLmNvbXBhY3RPYmplY3Qoc3RhdGUpLFxuICAgICAgLi4uXy5jb21wYWN0T2JqZWN0KHByb3BzKVxuICAgIH1cbiAgICByZXR1cm4gcmVzb2x2ZWRTdGF0ZVxuICB9LFxuXG4gIGNvbXBvbmVudFdpbGxNb3VudCAoKSB7XG4gICAgdGhpcy5zZXRTdGF0ZVdpdGhEYXRhKHRoaXMuZ2V0RGF0YU1vZGVsKHRoaXMuZ2V0UmVzb2x2ZWRTdGF0ZSgpKSlcbiAgfSxcblxuICBjb21wb25lbnREaWRNb3VudCAoKSB7XG4gICAgdGhpcy5maXJlT25DaGFuZ2UoKVxuICB9LFxuXG4gIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgKG5leHRQcm9wcywgbmV4dFN0YXRlKSB7XG4gICAgY29uc3Qgb2xkU3RhdGUgPSB0aGlzLmdldFJlc29sdmVkU3RhdGUoKVxuICAgIGNvbnN0IG5ld1N0YXRlID0gdGhpcy5nZXRSZXNvbHZlZFN0YXRlKG5leHRQcm9wcywgbmV4dFN0YXRlKVxuXG4gICAgaWYgKG9sZFN0YXRlLmRlZmF1bHRTb3J0aW5nICE9PSBuZXdTdGF0ZS5kZWZhdWx0U29ydGluZykge1xuICAgICAgbmV3U3RhdGUuc29ydGluZyA9IG5ld1N0YXRlLmRlZmF1bHRTb3J0aW5nXG4gICAgfVxuXG4gICAgaWYgKChvbGRTdGF0ZS5zaG93RmlsdGVycyAhPT0gbmV3U3RhdGUuc2hvd0ZpbHRlcnMpIHx8XG4gICAgICAob2xkU3RhdGUuc2hvd0ZpbHRlcnMgIT09IG5ld1N0YXRlLnNob3dGaWx0ZXJzKSkge1xuICAgICAgbmV3U3RhdGUuZmlsdGVyaW5nID0gbmV3U3RhdGUuZGVmYXVsdEZpbHRlcmluZ1xuICAgIH1cblxuICAgIC8vIFByb3BzIHRoYXQgdHJpZ2dlciBhIGRhdGEgdXBkYXRlXG4gICAgaWYgKFxuICAgICAgb2xkU3RhdGUuZGF0YSAhPT0gbmV3U3RhdGUuZGF0YSB8fFxuICAgICAgb2xkU3RhdGUuY29sdW1ucyAhPT0gbmV3U3RhdGUuY29sdW1ucyB8fFxuICAgICAgb2xkU3RhdGUucGl2b3RCeSAhPT0gbmV3U3RhdGUucGl2b3RCeSB8fFxuICAgICAgb2xkU3RhdGUuc29ydGluZyAhPT0gbmV3U3RhdGUuc29ydGluZyB8fFxuICAgICAgb2xkU3RhdGUuc2hvd0ZpbHRlcnMgIT09IG5ld1N0YXRlLnNob3dGaWx0ZXJzIHx8XG4gICAgICBvbGRTdGF0ZS5maWx0ZXJpbmcgIT09IG5ld1N0YXRlLmZpbHRlcmluZ1xuICAgICkge1xuICAgICAgdGhpcy5zZXRTdGF0ZVdpdGhEYXRhKHRoaXMuZ2V0RGF0YU1vZGVsKG5ld1N0YXRlKSlcbiAgICB9XG4gIH0sXG5cbiAgc2V0U3RhdGVXaXRoRGF0YSAobmV3U3RhdGUsIGNiKSB7XG4gICAgY29uc3Qgb2xkU3RhdGUgPSB0aGlzLmdldFJlc29sdmVkU3RhdGUoKVxuICAgIGNvbnN0IG5ld1Jlc29sdmVkU3RhdGUgPSB0aGlzLmdldFJlc29sdmVkU3RhdGUoe30sIG5ld1N0YXRlKVxuICAgIGNvbnN0IHtmcmVlemVXaGVuRXhwYW5kZWR9ID0gbmV3UmVzb2x2ZWRTdGF0ZVxuXG4gICAgLy8gRGVmYXVsdCB0byB1bmZyb3plbiBzdGF0ZVxuICAgIG5ld1Jlc29sdmVkU3RhdGUuZnJvemVuID0gZmFsc2VcblxuICAgIC8vIElmIGZyZWV6ZVdoZW5FeHBhbmRlZCBpcyBzZXQsIGNoZWNrIGZvciBmcm96ZW4gY29uZGl0aW9uc1xuICAgIGlmIChmcmVlemVXaGVuRXhwYW5kZWQpIHtcbiAgICAgIC8vIGlmIGFueSByb3dzIGFyZSBleHBhbmRlZCwgZnJlZXplIHRoZSBleGlzdGluZyBkYXRhIGFuZCBzb3J0aW5nXG4gICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobmV3UmVzb2x2ZWRTdGF0ZS5leHBhbmRlZFJvd3MpXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKG5ld1Jlc29sdmVkU3RhdGUuZXhwYW5kZWRSb3dzW2tleXNbaV1dKSB7XG4gICAgICAgICAgbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4gPSB0cnVlXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIElmIHRoZSBkYXRhIGlzbid0IGZyb3plbiBhbmQgZWl0aGVyIHRoZSBkYXRhIG9yXG4gICAgLy8gc29ydGluZyBtb2RlbCBoYXMgY2hhbmdlZCwgdXBkYXRlIHRoZSBkYXRhXG4gICAgaWYgKFxuICAgICAgKG9sZFN0YXRlLmZyb3plbiAmJiAhbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4pIHx8XG4gICAgICBvbGRTdGF0ZS5zb3J0aW5nICE9PSBuZXdSZXNvbHZlZFN0YXRlLnNvcnRpbmcgfHxcbiAgICAgIG9sZFN0YXRlLmZpbHRlcmluZyAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5maWx0ZXJpbmcgfHxcbiAgICAgIG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdSZXNvbHZlZFN0YXRlLnNob3dGaWx0ZXJzIHx8XG4gICAgICAoIW5ld1Jlc29sdmVkU3RhdGUuZnJvemVuICYmIG9sZFN0YXRlLnJlc29sdmVkRGF0YSAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5yZXNvbHZlZERhdGEpXG4gICAgKSB7XG4gICAgICAvLyBIYW5kbGUgY29sbGFwc2VPblNvcnRpbmdDaGFuZ2UgJiBjb2xsYXBzZU9uRGF0YUNoYW5nZVxuICAgICAgaWYgKFxuICAgICAgICAob2xkU3RhdGUuc29ydGluZyAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5zb3J0aW5nICYmIHRoaXMucHJvcHMuY29sbGFwc2VPblNvcnRpbmdDaGFuZ2UpIHx8XG4gICAgICAgIChvbGRTdGF0ZS5maWx0ZXJpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuZmlsdGVyaW5nKSB8fFxuICAgICAgICAob2xkU3RhdGUuc2hvd0ZpbHRlcnMgIT09IG5ld1Jlc29sdmVkU3RhdGUuc2hvd0ZpbHRlcnMpIHx8XG4gICAgICAgICghbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4gJiYgb2xkU3RhdGUucmVzb2x2ZWREYXRhICE9PSBuZXdSZXNvbHZlZFN0YXRlLnJlc29sdmVkRGF0YSAmJiB0aGlzLnByb3BzLmNvbGxhcHNlT25EYXRhQ2hhbmdlKVxuICAgICAgKSB7XG4gICAgICAgIG5ld1Jlc29sdmVkU3RhdGUuZXhwYW5kZWRSb3dzID0ge31cbiAgICAgIH1cblxuICAgICAgT2JqZWN0LmFzc2lnbihuZXdSZXNvbHZlZFN0YXRlLCB0aGlzLmdldFNvcnRlZERhdGEobmV3UmVzb2x2ZWRTdGF0ZSkpXG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHBhZ2VTaXplIGFsbCB0aGUgdGltZVxuICAgIGlmIChuZXdSZXNvbHZlZFN0YXRlLnNvcnRlZERhdGEpIHtcbiAgICAgIG5ld1Jlc29sdmVkU3RhdGUucGFnZXMgPSBuZXdSZXNvbHZlZFN0YXRlLm1hbnVhbCA/IG5ld1Jlc29sdmVkU3RhdGUucGFnZXMgOiBNYXRoLmNlaWwobmV3UmVzb2x2ZWRTdGF0ZS5zb3J0ZWREYXRhLmxlbmd0aCAvIG5ld1Jlc29sdmVkU3RhdGUucGFnZVNpemUpXG4gICAgICBuZXdSZXNvbHZlZFN0YXRlLnBhZ2UgPSBNYXRoLm1heChuZXdSZXNvbHZlZFN0YXRlLnBhZ2UgPj0gbmV3UmVzb2x2ZWRTdGF0ZS5wYWdlcyA/IG5ld1Jlc29sdmVkU3RhdGUucGFnZXMgLSAxIDogbmV3UmVzb2x2ZWRTdGF0ZS5wYWdlLCAwKVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnNldFN0YXRlKG5ld1Jlc29sdmVkU3RhdGUsIGNiKVxuICB9XG59XG4iXX0=